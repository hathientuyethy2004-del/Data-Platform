version: '3.8'

services:
  # ============================================================================
  # SPARK CLUSTER - Master & Worker nodes for distributed processing
  # ============================================================================

  # Spark Master
  spark-master:
    image: apache/spark:3.5.0
    container_name: spark-master
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master --host 0.0.0.0 --port 7077 --webui-port 8080
    ports:
      - "8080:8080"    # Web UI
      - "7077:7077"    # Spark Master port
      - "4040:4040"    # Driver UI (when running jobs)
    networks:
      - data-platform
    volumes:
      - spark-master-data:/home/spark
    restart: unless-stopped

  # Spark Worker 1
  spark-worker-1:
    image: apache/spark:3.5.0
    container_name: spark-worker-1
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 --webui-port 8081 --memory 2G --cores 2
    ports:
      - "8081:8081"
    depends_on:
      - spark-master
    networks:
      - data-platform
    volumes:
      - spark-worker-1-data:/home/spark
    restart: unless-stopped

  # Spark Worker 2
  spark-worker-2:
    image: apache/spark:3.5.0
    container_name: spark-worker-2
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 --webui-port 8082 --memory 2G --cores 2
    ports:
      - "8082:8082"
    depends_on:
      - spark-master
    networks:
      - data-platform
    volumes:
      - spark-worker-2-data:/home/spark
    restart: unless-stopped

  # ============================================================================
  # Processing Layer Jobs Runner (optional - for running jobs locally)
  # ============================================================================

  processing-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: processing-orchestrator
    depends_on:
      spark-master:
        condition: service_healthy
    environment:
      SPARK_MASTER: spark://spark-master:7077
      KAFKA_BOOTSTRAP_SERVER: localhost:29092
      CHECKPOINT_DIR: /var/lib/spark/checkpoints
      OUTPUTS_DIR: /var/lib/spark/outputs
      LOG_LEVEL: INFO
    networks:
      - data-platform
    volumes:
      - ./jobs:/processing/jobs
      - ./configs:/processing/configs
      - ./utils:/processing/utils
      - spark-outputs:/var/lib/spark/outputs
      - spark-checkpoints:/var/lib/spark/checkpoints
      - ./logs:/var/lib/spark/logs
    restart: unless-stopped

networks:
  data-platform:
    external: true

volumes:
  spark-master-data:
  spark-worker-1-data:
  spark-worker-2-data:
  spark-outputs:
  spark-checkpoints:
