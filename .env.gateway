#!/usr/bin/env bash
# Data Platform API Gateway environment presets
# Usage:
#   source .env.gateway
#   gateway_env_dev      # or gateway_env_staging / gateway_env_prod
#   gateway_run

_gateway_clear_overrides() {
  unset PLATFORM_PRODUCT_SERVICES_JSON
  unset PLATFORM_PRODUCT_SERVICES_BY_ENV_JSON
  unset PLATFORM_PRODUCT_SERVICES_DEV_JSON
  unset PLATFORM_PRODUCT_SERVICES_STAGING_JSON
  unset PLATFORM_PRODUCT_SERVICES_PROD_JSON
}

gateway_env_dev() {
  _gateway_clear_overrides
  export PLATFORM_ENV="dev"
  export PLATFORM_PRODUCT_SERVICES_DEV_JSON='[
    {"name":"web-user-analytics","base_url":"http://127.0.0.1:8002","health_path":"/health","enabled":true},
    {"name":"operational-metrics","base_url":"http://127.0.0.1:8003","health_path":"/health","enabled":true},
    {"name":"compliance-auditing","base_url":"http://127.0.0.1:8004","health_path":"/health","enabled":true}
  ]'
  echo "Gateway environment set to DEV"
}

gateway_env_staging() {
  _gateway_clear_overrides
  export PLATFORM_ENV="staging"
  export PLATFORM_PRODUCT_SERVICES_STAGING_JSON='[
    {"name":"web-user-analytics","base_url":"http://web-user-analytics.staging:8002","health_path":"/health","enabled":true},
    {"name":"operational-metrics","base_url":"http://operational-metrics.staging:8003","health_path":"/health","enabled":true},
    {"name":"compliance-auditing","base_url":"http://compliance-auditing.staging:8004","health_path":"/health","enabled":true}
  ]'
  echo "Gateway environment set to STAGING"
}

gateway_env_prod() {
  _gateway_clear_overrides
  export PLATFORM_ENV="prod"
  export PLATFORM_PRODUCT_SERVICES_PROD_JSON='[
    {"name":"web-user-analytics","base_url":"http://web-user-analytics.prod:8002","health_path":"/health","enabled":true},
    {"name":"operational-metrics","base_url":"http://operational-metrics.prod:8003","health_path":"/health","enabled":true},
    {"name":"compliance-auditing","base_url":"http://compliance-auditing.prod:8004","health_path":"/health","enabled":true}
  ]'
  echo "Gateway environment set to PROD"
}

gateway_show_env() {
  echo "PLATFORM_ENV=${PLATFORM_ENV:-<unset>}"
  env | grep '^PLATFORM_PRODUCT_SERVICES_' | sort
}

gateway_run() {
  PYTHONPATH=. uvicorn shared.platform.api_gateway:app --host 0.0.0.0 --port 8000
}
